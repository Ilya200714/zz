<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TITAN VIDEOCHAT</title>
    <style>
        :root { 
            --bg: #020205; --side: rgba(10, 10, 15, 0.95); --card: rgba(20, 20, 35, 0.8); 
            --accent: #00f2ff; --green: #39ff14; --red: #ff3131; --text: #e0e0ff; 
        }
        * { box-sizing: border-box; font-family: 'Orbitron', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        
        /* Windows */
        .win { position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
               display: flex; align-items: center; justify-content: center; 
               background: var(--bg); z-index: 1000; }
        
        /* Auth */
        .card { background: #0a0a15; padding: 30px; border-radius: 15px; 
                border: 2px solid var(--accent); text-align: center; width: 350px; }
        .card h1 { color: var(--accent); margin-bottom: 20px; }
        #p-ava { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--accent); 
                 margin: 15px auto; background: #111 center/cover; cursor: pointer; }
        .card input { width: 100%; padding: 10px; background: #000; color: #fff; 
                      border: 1px solid #333; margin: 5px 0; }
        .card button { width: 100%; padding: 12px; background: var(--accent); 
                       border: none; border-radius: 8px; font-weight: bold; 
                       margin-top: 10px; cursor: pointer; color: #000; }
        
        /* Main app */
        #app { display: none; height: 100vh; }
        .stage { flex: 1; display: flex; flex-wrap: wrap; padding: 15px; 
                 gap: 15px; overflow-y: auto; background: var(--bg); }
        
        /* Video boxes */
        .u-box { width: 300px; height: 200px; background: var(--card); 
                 border-radius: 10px; position: relative; border: 2px solid var(--accent); 
                 overflow: hidden; box-shadow: 0 0 10px rgba(0,242,255,0.3); }
        video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .u-nick { position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); 
                  padding: 3px 8px; border-radius: 4px; font-size: 12px; border: 1px solid var(--accent); }
        
        /* Sidebar */
        .side { width: 300px; background: var(--side); border-left: 2px solid var(--accent); 
                display: flex; flex-direction: column; }
        #user-list { padding: 15px; border-bottom: 1px solid #222; }
        .u-item { font-size: 12px; margin: 5px 0; color: var(--green); }
        #msgs { flex: 1; overflow-y: auto; padding: 10px; }
        .m { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; 
             margin: 5px 0; border-left: 3px solid var(--accent); font-size: 12px; }
        
        /* Dock */
        .dock { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; 
                background: #000; border-top: 2px solid var(--accent); 
                display: flex; align-items: center; justify-content: center; gap: 15px; }
        .icn { width: 45px; height: 45px; border-radius: 50%; border: 1px solid var(--accent); 
               background: #111; color: #fff; cursor: pointer; display: flex; 
               align-items: center; justify-content: center; font-size: 18px; }
        .icn.on { background: var(--green); color: #000; }
        
        /* Status */
        .status { position: fixed; top: 10px; right: 10px; background: #111; 
                  padding: 5px 10px; border-radius: 5px; font-size: 12px; 
                  border: 1px solid var(--red); color: var(--red); }
        .status.online { border-color: var(--green); color: var(--green); }
    </style>
</head>
<body>
    <div id="status" class="status">‚óè OFFLINE</div>
    
    <!-- Auth Screen -->
    <div id="w-auth" class="win">
        <div class="card">
            <h1>üöÄ TITAN CHAT</h1>
            <div id="p-ava" onclick="document.getElementById('f-ava').click()"></div>
            <input type="file" id="f-ava" hidden accept="image/*">
            <input type="text" id="i-nick" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫" autocomplete="off">
            <button onclick="register()">–í–û–ô–¢–ò</button>
        </div>
    </div>
    
    <!-- Lobby -->
    <div id="w-lobby" class="win" style="display:none">
        <div class="card">
            <h2 id="l-nick" style="color:var(--green)"></h2>
            <input type="text" id="i-room" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: titan)" value="titan">
            <p style="font-size: 12px; color: #888; margin: 10px 0;">–û–±–∞ –≤–≤–µ–¥–∏—Ç–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π ID</p>
            <button onclick="start()" style="background:var(--green)">–í–û–ô–¢–ò –í –ö–û–ú–ù–ê–¢–£</button>
            <p style="font-size: 10px; color: #666; margin-top: 15px;">
                –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤–∫–ª—é—á–∏—Ç–µ –∫–∞–º–µ—Ä—É/–º–∏–∫—Ä–æ—Ñ–æ–Ω –∫–Ω–æ–ø–∫–∞–º–∏ –≤–Ω–∏–∑—É
            </p>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="app">
        <div class="stage" id="stage"></div>
        <div class="side">
            <div id="user-list">
                <div style="color: var(--accent); margin-bottom: 10px;">–£—á–∞—Å—Ç–Ω–∏–∫–∏:</div>
                <div id="u-items"></div>
            </div>
            <div id="msgs"></div>
            <div style="padding: 10px; background: #000;">
                <input type="text" id="c-in" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                       style="width:100%; padding:8px; background:#111; border:1px solid #333; color:#fff;">
            </div>
        </div>
    </div>
    
    <!-- Dock -->
    <div class="dock" id="dock" style="display:none">
        <button class="icn" onclick="toggleMedia('audio')" id="b-mic">üéôÔ∏è</button>
        <button class="icn" onclick="toggleMedia('video')" id="b-cam">üì∑</button>
        <button class="icn" onclick="shareScreen()" id="b-scr">üñ•Ô∏è</button>
        <button class="icn" style="background:var(--red)" onclick="leaveRoom()">üö™ –í—ã–π—Ç–∏</button>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let ws = null;
        let myUserId = null;
        let currentRoom = null;
        let myStream = null;
        let peerConnections = {};
        let profile = { nick: '', id: Date.now().toString(36) };
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
        const saved = localStorage.getItem('titan_profile');
        if (saved) {
            profile = JSON.parse(saved);
            showLobby();
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        function register() {
            const nick = document.getElementById('i-nick').value.trim();
            if (!nick) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫!');
            
            profile.nick = nick;
            localStorage.setItem('titan_profile', JSON.stringify(profile));
            showLobby();
        }
        
        function showLobby() {
            document.getElementById('w-auth').style.display = 'none';
            document.getElementById('w-lobby').style.display = 'flex';
            document.getElementById('l-nick').textContent = '–ù–∏–∫: ' + profile.nick;
        }
        
        // –°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function start() {
            currentRoom = document.getElementById('i-room').value.trim() || 'titan';
            myUserId = profile.id + '-' + Date.now();
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
            connectWebSocket();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–±–±–∏
            document.getElementById('w-lobby').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('dock').style.display = 'flex';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è
            addBox(myUserId, profile.nick, true);
        }
        
        // WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected');
                updateStatus(true);
                
                // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
                ws.send(JSON.stringify({
                    type: 'join',
                    roomId: currentRoom,
                    userId: myUserId,
                    nick: profile.nick
                }));
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('üì® Received:', data.type);
                    
                    switch(data.type) {
                        case 'joined':
                            data.users.forEach(user => {
                                if (user.userId !== myUserId) {
                                    addBox(user.userId, user.nick);
                                    createPeerConnection(user.userId);
                                }
                            });
                            break;
                            
                        case 'user-joined':
                            if (data.userId !== myUserId) {
                                addBox(data.userId, data.nick);
                                createPeerConnection(data.userId);
                            }
                            break;
                            
                        case 'user-left':
                            removeBox(data.userId);
                            break;
                            
                        case 'signal':
                            handleSignal(data);
                            break;
                            
                        case 'chat':
                            addMessage(data.fromNick, data.message);
                            break;
                    }
                } catch (e) {
                    console.error('‚ùå Parse error:', e);
                }
            };
            
            ws.onclose = () => {
                console.log('‚ùå WebSocket disconnected');
                updateStatus(false);
                setTimeout(connectWebSocket, 2000);
            };
            
            ws.onerror = (error) => {
                console.error('‚ùå WebSocket error:', error);
            };
        }
        
        // UI —Ñ—É–Ω–∫—Ü–∏–∏
        function updateStatus(online) {
            const el = document.getElementById('status');
            el.textContent = online ? '‚óè ONLINE' : '‚óè OFFLINE';
            el.className = online ? 'status online' : 'status';
        }
        
        function addBox(userId, nick, isMe = false) {
            if (document.getElementById('box-' + userId)) return;
            
            const box = document.createElement('div');
            box.className = 'u-box';
            box.id = 'box-' + userId;
            box.innerHTML = `
                <video id="video-${userId}" autoplay playsinline ${isMe ? 'muted' : ''}></video>
                <div class="u-nick">${isMe ? 'üë§ ' + nick : nick}</div>
                ${!isMe ? `<div style="position:absolute; top:5px; left:5px;">
                    <input type="range" min="0" max="1" step="0.1" value="1" 
                           style="width:60px;" oninput="setVolume('${userId}', this.value)">
                </div>` : ''}
            `;
            
            document.getElementById('stage').appendChild(box);
            updateUserList(userId, nick, true);
        }
        
        function removeBox(userId) {
            const box = document.getElementById('box-' + userId);
            if (box) box.remove();
            updateUserList(userId, '', false);
            
            if (peerConnections[userId]) {
                peerConnections[userId].close();
                delete peerConnections[userId];
            }
        }
        
        function updateUserList(userId, nick, add) {
            const container = document.getElementById('u-items');
            
            if (add) {
                if (!document.getElementById('item-' + userId)) {
                    const item = document.createElement('div');
                    item.className = 'u-item';
                    item.id = 'item-' + userId;
                    item.textContent = '‚óè ' + nick;
                    container.appendChild(item);
                }
            } else {
                document.getElementById('item-' + userId)?.remove();
            }
        }
        
        function addMessage(from, text) {
            const container = document.getElementById('msgs');
            const msg = document.createElement('div');
            msg.className = 'm';
            msg.innerHTML = `<b>${from}:</b> ${text}`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }
        
        // WebRTC
        function createPeerConnection(otherUserId) {
            if (peerConnections[otherUserId]) return;
            
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });
            
            peerConnections[otherUserId] = pc;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à–∏ —Ç—Ä–µ–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (myStream) {
                myStream.getTracks().forEach(track => {
                    pc.addTrack(track, myStream);
                });
            }
            
            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            pc.onicecandidate = (event) => {
                if (event.candidate && ws) {
                    ws.send(JSON.stringify({
                        type: 'signal',
                        to: otherUserId,
                        signal: { type: 'candidate', candidate: event.candidate }
                    }));
                }
            };
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
            pc.ontrack = (event) => {
                const stream = event.streams[0];
                const video = document.getElementById('video-' + otherUserId);
                if (video) {
                    video.srcObject = stream;
                }
            };
            
            // –°–æ–∑–¥–∞–µ–º offer
            pc.createOffer()
                .then(offer => pc.setLocalDescription(offer))
                .then(() => {
                    if (ws) {
                        ws.send(JSON.stringify({
                            type: 'signal',
                            to: otherUserId,
                            signal: { type: 'offer', sdp: pc.localDescription }
                        }));
                    }
                });
        }
        
        function handleSignal(data) {
            const pc = peerConnections[data.from];
            if (!pc) return;
            
            if (data.signal.type === 'offer') {
                pc.setRemoteDescription(new RTCSessionDescription(data.signal.sdp))
                    .then(() => pc.createAnswer())
                    .then(answer => pc.setLocalDescription(answer))
                    .then(() => {
                        ws.send(JSON.stringify({
                            type: 'signal',
                            to: data.from,
                            signal: { type: 'answer', sdp: pc.localDescription }
                        }));
                    });
            } else if (data.signal.type === 'answer') {
                pc.setRemoteDescription(new RTCSessionDescription(data.signal.sdp));
            } else if (data.signal.type === 'candidate') {
                pc.addIceCandidate(new RTCIceCandidate(data.signal.candidate));
            }
        }
        
        // –ú–µ–¥–∏–∞ —Ñ—É–Ω–∫—Ü–∏–∏
        async function toggleMedia(type) {
            const btn = document.getElementById('b-' + (type === 'video' ? 'cam' : 'mic'));
            
            if (!myStream) {
                try {
                    myStream = await navigator.mediaDevices.getUserMedia({
                        video: type === 'video',
                        audio: type === 'audio'
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–µ –≤–∏–¥–µ–æ
                    const myVideo = document.getElementById('video-' + myUserId);
                    if (myVideo) {
                        myVideo.srcObject = myStream;
                    }
                    
                    btn.classList.add('on');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏ –∫–æ –≤—Å–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º
                    Object.values(peerConnections).forEach(pc => {
                        myStream.getTracks().forEach(track => {
                            pc.addTrack(track, myStream);
                        });
                    });
                } catch (err) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ ' + (type === 'video' ? '–∫–∞–º–µ—Ä–µ' : '–º–∏–∫—Ä–æ—Ñ–æ–Ω—É'));
                }
            } else {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç—Ä–µ–∫
                const tracks = myStream.getTracks().filter(t => t.kind === type);
                if (tracks.length > 0) {
                    const enabled = !tracks[0].enabled;
                    tracks.forEach(track => track.enabled = enabled);
                    if (enabled) btn.classList.add('on');
                    else btn.classList.remove('on');
                }
            }
        }
        
        async function shareScreen() {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const video = document.getElementById('video-' + myUserId);
                if (video) video.srcObject = stream;
                
                // –ó–∞–º–µ–Ω—è–µ–º –≤–∏–¥–µ–æ —Ç—Ä–µ–∫ —É –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
                Object.values(peerConnections).forEach(pc => {
                    const senders = pc.getSenders();
                    const videoSender = senders.find(s => s.track?.kind === 'video');
                    if (videoSender) {
                        videoSender.replaceTrack(stream.getVideoTracks()[0]);
                    }
                });
                
                document.getElementById('b-scr').classList.add('on');
                
                stream.getVideoTracks()[0].onended = () => {
                    document.getElementById('b-scr').classList.remove('on');
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–º–µ—Ä—É –µ—Å–ª–∏ –±—ã–ª–∞
                    if (myStream) {
                        const video = document.getElementById('video-' + myUserId);
                        if (video) video.srcObject = myStream;
                    }
                };
            } catch (err) {
                console.log('Screen sharing cancelled');
            }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ
        function setVolume(userId, volume) {
            const video = document.getElementById('video-' + userId);
            if (video) video.volume = volume;
        }
        
        function leaveRoom() {
            if (ws) {
                ws.send(JSON.stringify({ type: 'leave' }));
                ws.close();
            }
            
            Object.values(peerConnections).forEach(pc => pc.close());
            if (myStream) myStream.getTracks().forEach(t => t.stop());
            
            location.reload();
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        document.getElementById('c-in').onkeypress = (e) => {
            if (e.key === 'Enter' && ws) {
                const text = e.target.value.trim();
                if (text) {
                    ws.send(JSON.stringify({ type: 'chat', message: text }));
                    addMessage('–Ø', text);
                    e.target.value = '';
                }
            }
        };
    </script>
</body>
</html>