<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ TITAN VIDEOCHAT</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: #0a0a0a; 
            color: #00ffea; 
            height: 100vh; 
            overflow: hidden;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã */
        .container { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            display: flex; 
            flex-direction: column;
        }
        
        /* –®–∞–ø–∫–∞ */
        .header {
            background: #111;
            padding: 15px;
            border-bottom: 2px solid #00ffea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .status.online { background: #0a5; }
        .status.offline { background: #a00; }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* –í–∏–¥–µ–æ —Å–µ—Ç–∫–∞ */
        .videos {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            padding: 10px;
            overflow-y: auto;
        }
        
        .video-box {
            background: #222;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            border: 2px solid #00aaff;
        }
        
        video {
            width: 100%;
            height: 100%;
            background: #000;
            display: block;
        }
        
        .video-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            width: 300px;
            background: #111;
            border-left: 2px solid #00ffea;
            display: flex;
            flex-direction: column;
        }
        
        .users {
            padding: 10px;
            border-bottom: 1px solid #333;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .user-item {
            padding: 5px;
            margin: 2px 0;
            background: #222;
            border-radius: 4px;
        }
        
        .chat {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            margin: 5px 0;
            padding: 8px;
            background: #222;
            border-radius: 6px;
            border-left: 3px solid #00aaff;
        }
        
        .chat-input {
            padding: 10px;
            background: #000;
            border-top: 1px solid #333;
        }
        
        .chat-input input {
            width: 100%;
            padding: 10px;
            background: #222;
            border: 1px solid #00aaff;
            color: #fff;
            border-radius: 4px;
        }
        
        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls {
            background: #111;
            padding: 15px;
            border-top: 2px solid #00ffea;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #00ffea;
            background: #222;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn.active {
            background: #0a5;
        }
        
        .btn.exit {
            background: #a00;
            border-color: #f00;
        }
        
        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        .login-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #0a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .login-box {
            background: #111;
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #00ffea;
            width: 350px;
            text-align: center;
        }
        
        .login-box input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #222;
            border: 1px solid #00aaff;
            color: #fff;
            border-radius: 4px;
        }
        
        .login-box button {
            width: 100%;
            padding: 12px;
            background: #00ffea;
            color: #000;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1 style="color: #00ffea; margin-bottom: 20px;">üöÄ TITAN CHAT</h1>
            <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫" autocomplete="off">
            <input type="text" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="titan" autocomplete="off">
            <button onclick="login()">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø</button>
            <p style="margin-top: 15px; font-size: 12px; color: #888;">
                –í–≤–µ–¥–∏—Ç–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π ID –∫–æ–º–Ω–∞—Ç—ã —Å –¥—Ä—É–≥–æ–º –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É
            </p>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="mainApp" class="container hidden">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="header">
            <h2>üéÆ TITAN VIDEOCHAT</h2>
            <div id="status" class="status offline">OFFLINE</div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="main">
            <!-- –í–∏–¥–µ–æ —Å–µ—Ç–∫–∞ -->
            <div id="videos" class="videos"></div>
            
            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="sidebar">
                <div class="users">
                    <h4 style="margin-bottom: 10px;">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏:</h4>
                    <div id="userList"></div>
                </div>
                <div class="chat">
                    <h4 style="margin-bottom: 10px;">üí¨ –ß–∞—Ç:</h4>
                    <div id="messages"></div>
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                           onkeypress="if(event.key === 'Enter') sendMessage()">
                </div>
            </div>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="controls">
            <button id="micBtn" class="btn" onclick="toggleMic()">üéôÔ∏è</button>
            <button id="camBtn" class="btn" onclick="toggleCam()">üì∑</button>
            <button id="screenBtn" class="btn" onclick="toggleScreen()">üñ•Ô∏è</button>
            <button class="btn exit" onclick="disconnect()">üö™</button>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let ws = null;
        let myId = null;
        let myNick = null;
        let currentRoom = null;
        let localStream = null;
        let screenStream = null;
        let peerConnections = new Map();
        
        // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            console.log('–ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫:', wsUrl);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                updateStatus(true);
            };
            
            ws.onmessage = async (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ:', data.type);
                    
                    switch(data.type) {
                        case 'hello':
                            console.log('–°–µ—Ä–≤–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç:', data.message);
                            break;
                            
                        case 'room_joined':
                            myId = data.userId;
                            console.log('–í–æ—à—ë–ª –≤ –∫–æ–º–Ω–∞—Ç—É:', data.roomId);
                            console.log('–£—á–∞—Å—Ç–Ω–∏–∫–∏:', data.users);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                            data.users.forEach(user => {
                                if (user.userId !== myId) {
                                    addVideoBox(user.userId, user.nick);
                                }
                            });
                            break;
                            
                        case 'user_joined':
                            console.log('–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫:', data.nick);
                            addVideoBox(data.userId, data.nick);
                            break;
                            
                        case 'user_left':
                            console.log('–£—á–∞—Å—Ç–Ω–∏–∫ –≤—ã—à–µ–ª:', data.userId);
                            removeVideoBox(data.userId);
                            break;
                            
                        case 'signal':
                            await handleSignal(data);
                            break;
                            
                        case 'chat_message':
                            addMessage(data.fromNick, data.message);
                            break;
                            
                        case 'pong':
                            // –ü–∏–Ω–≥-–ø–æ–Ω–≥
                            break;
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                }
            };
            
            ws.onclose = () => {
                console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                updateStatus(false);
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('üí• WebSocket –æ—à–∏–±–∫–∞:', error);
            };
        }
        
        // –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
        async function login() {
            myNick = document.getElementById('username').value.trim();
            currentRoom = document.getElementById('roomId').value.trim();
            
            if (!myNick) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫!');
                return;
            }
            
            if (!currentRoom) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã!');
                return;
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
            connectWebSocket();
            
            // –ñ–¥—ë–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket
            setTimeout(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'join',
                        roomId: currentRoom,
                        userId: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        nick: myNick,
                        avatar: ''
                    }));
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ—ë –≤–∏–¥–µ–æ
                    addVideoBox('self', myNick);
                }
            }, 1000);
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ –±–æ–∫—Å–∞
        function addVideoBox(userId, nick) {
            if (document.getElementById('video-' + userId)) return;
            
            const videosContainer = document.getElementById('videos');
            const videoBox = document.createElement('div');
            videoBox.className = 'video-box';
            videoBox.id = 'video-' + userId;
            
            videoBox.innerHTML = `
                <video id="stream-${userId}" autoplay playsinline ${userId === 'self' ? 'muted' : ''}></video>
                <div class="video-info">${nick}</div>
            `;
            
            videosContainer.appendChild(videoBox);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            updateUserList(userId, nick, true);
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ –±–æ–∫—Å–∞
        function removeVideoBox(userId) {
            const videoBox = document.getElementById('video-' + userId);
            if (videoBox) {
                videoBox.remove();
            }
            
            updateUserList(userId, '', false);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º peer connection
            if (peerConnections.has(userId)) {
                peerConnections.get(userId).close();
                peerConnections.delete(userId);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function updateUserList(userId, nick, add) {
            const userList = document.getElementById('userList');
            
            if (add) {
                if (!document.getElementById('user-item-' + userId)) {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.id = 'user-item-' + userId;
                    userItem.textContent = 'üë§ ' + nick;
                    userList.appendChild(userItem);
                }
            } else {
                const userItem = document.getElementById('user-item-' + userId);
                if (userItem) {
                    userItem.remove();
                }
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessage(from, text) {
            const messages = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = 'message';
            message.innerHTML = `<strong>${from}:</strong> ${text}`;
            messages.appendChild(message);
            messages.scrollTop = messages.scrollHeight;
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !ws) return;
            
            ws.send(JSON.stringify({
                type: 'message',
                message: text
            }));
            
            addMessage('–Ø', text);
            input.value = '';
        }
        
        // WebRTC —Å–∏–≥–Ω–∞–ª—ã
        async function handleSignal(data) {
            const { from, signal } = data;
            
            if (signal.type === 'offer') {
                await createPeerConnection(from);
                const pc = peerConnections.get(from);
                await pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                ws.send(JSON.stringify({
                    type: 'signal',
                    to: from,
                    signal: {
                        type: 'answer',
                        sdp: pc.localDescription
                    }
                }));
            } else if (signal.type === 'answer') {
                const pc = peerConnections.get(from);
                if (pc) {
                    await pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
                }
            } else if (signal.type === 'candidate') {
                const pc = peerConnections.get(from);
                if (pc) {
                    await pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
                }
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ peer connection
        async function createPeerConnection(userId) {
            if (peerConnections.has(userId)) return;
            
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' }
                ]
            });
            
            peerConnections.set(userId, pc);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            pc.onicecandidate = (event) => {
                if (event.candidate && ws) {
                    ws.send(JSON.stringify({
                        type: 'signal',
                        to: userId,
                        signal: {
                            type: 'candidate',
                            candidate: event.candidate
                        }
                    }));
                }
            };
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
            pc.ontrack = (event) => {
                const stream = event.streams[0];
                const video = document.getElementById('stream-' + userId);
                if (video) {
                    video.srcObject = stream;
                }
            };
            
            // –°–æ–∑–¥–∞—ë–º offer –µ—Å–ª–∏ –º—ã –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—ã
            setTimeout(async () => {
                try {
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    
                    ws.send(JSON.stringify({
                        type: 'signal',
                        to: userId,
                        signal: {
                            type: 'offer',
                            sdp: pc.localDescription
                        }
                    }));
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer:', error);
                }
            }, 1000);
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞
        async function toggleMic() {
            const btn = document.getElementById('micBtn');
            
            if (!localStream) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    btn.classList.add('active');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ —Ç—Ä–µ–∫ –∫–æ –≤—Å–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º
                    peerConnections.forEach((pc, userId) => {
                        const audioTrack = localStream.getAudioTracks()[0];
                        if (audioTrack) {
                            const sender = pc.getSenders().find(s => s.track?.kind === 'audio');
                            if (sender) {
                                sender.replaceTrack(audioTrack);
                            } else {
                                pc.addTrack(audioTrack, localStream);
                            }
                        }
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                }
            } else {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    if (audioTrack.enabled) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            }
        }
        
        async function toggleCam() {
            const btn = document.getElementById('camBtn');
            
            if (!localStream) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    btn.classList.add('active');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ—ë –≤–∏–¥–µ–æ
                    const selfVideo = document.getElementById('stream-self');
                    if (selfVideo) {
                        selfVideo.srcObject = localStream;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ —Ç—Ä–µ–∫ –∫–æ –≤—Å–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º
                    peerConnections.forEach((pc, userId) => {
                        const videoTrack = localStream.getVideoTracks()[0];
                        if (videoTrack) {
                            const sender = pc.getSenders().find(s => s.track?.kind === 'video');
                            if (sender) {
                                sender.replaceTrack(videoTrack);
                            } else {
                                pc.addTrack(videoTrack, localStream);
                            }
                        }
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
                }
            } else {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    if (videoTrack.enabled) {
                        btn.classList.add('active');
                        const selfVideo = document.getElementById('stream-self');
                        if (selfVideo) {
                            selfVideo.srcObject = localStream;
                        }
                    } else {
                        btn.classList.remove('active');
                    }
                }
            }
        }
        
        async function toggleScreen() {
            const btn = document.getElementById('screenBtn');
            
            if (!screenStream) {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    btn.classList.add('active');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤–º–µ—Å—Ç–æ –∫–∞–º–µ—Ä—ã
                    const selfVideo = document.getElementById('stream-self');
                    if (selfVideo) {
                        selfVideo.srcObject = screenStream;
                    }
                    
                    // –ó–∞–º–µ–Ω—è–µ–º –≤–∏–¥–µ–æ —Ç—Ä–µ–∫ —É –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
                    peerConnections.forEach((pc, userId) => {
                        const sender = pc.getSenders().find(s => s.track?.kind === 'video');
                        if (sender && screenStream.getVideoTracks()[0]) {
                            sender.replaceTrack(screenStream.getVideoTracks()[0]);
                        }
                    });
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                    screenStream.getVideoTracks()[0].onended = () => {
                        screenStream = null;
                        btn.classList.remove('active');
                        
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–º–µ—Ä—É –µ—Å–ª–∏ –±—ã–ª–∞
                        if (localStream) {
                            const selfVideo = document.getElementById('stream-self');
                            if (selfVideo) {
                                selfVideo.srcObject = localStream;
                            }
                            
                            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–º–µ—Ä—É –¥–ª—è –≤—Å–µ—Ö
                            peerConnections.forEach((pc, userId) => {
                                const sender = pc.getSenders().find(s => s.track?.kind === 'video');
                                if (sender && localStream.getVideoTracks()[0]) {
                                    sender.replaceTrack(localStream.getVideoTracks()[0]);
                                }
                            });
                        }
                    };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞:', error);
                }
            }
        }
        
        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
        function disconnect() {
            if (ws) {
                ws.send(JSON.stringify({ type: 'leave' }));
                ws.close();
            }
            
            peerConnections.forEach(pc => pc.close());
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (screenStream) screenStream.getTracks().forEach(track => track.stop());
            
            location.reload();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(online) {
            const status = document.getElementById('status');
            status.textContent = online ? 'ONLINE' : 'OFFLINE';
            status.className = `status ${online ? 'online' : 'offline'}`;
        }
        
        // –ê–≤—Ç–æ-—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.getElementById('username').focus();
    </script>
</body>
</html>
